{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container my-4">

  <!-- Hotel Header -->
  <div class="text-center mb-5">
    {% if hotel.logo %}
      <img src="{{ hotel.logo.url }}" alt="{{ hotel.name }}" class="rounded-circle shadow-sm" width="100" height="100">
    {% endif %}
    <h2 class="mt-3 fw-bold">{{ hotel.name }}</h2>
    <p class="text-muted">Manage and view menu items below</p>
  </div>

  <!-- Action Buttons -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div class="btn-group" role="group">
      <button id="btnList" class="btn btn-primary btn-sm active">List View</button>
      <button id="btnGrid" class="btn btn-outline-primary btn-sm">Grid View</button>
    </div>

    <div class="d-flex gap-2">
      <a href="{% url 'add_menu_item' hotel.id %}" class="btn btn-success btn-sm">+ Add New Menu Item</a>
      <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm">‚Üê Back to Dashboard</a>
    </div>
  </div>

  {% if grouped_menu %}
    <!-- ‚úÖ List View (Unified Table) -->
    <div id="listView">
      {% csrf_token %}
      <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
        <h4 class="text-primary mb-0">All Menu Items</h4>

        <div class="d-flex gap-2">
          <button type="button" id="deleteSelected" class="btn btn-danger btn-sm">
            üóëÔ∏è Delete Selected
          </button>
          <input type="text" id="menuSearch" class="form-control" placeholder="Search by name..." style="max-width: 300px;">
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle table-hover bg-white shadow-sm rounded" id="menuTable">
          <thead class="table-light">
            <tr>
              <th><input type="checkbox" id="selectAll"></th>
              <th>#</th>
              <th>Item</th>
              <th>Description</th>
              <th>Price (KD)</th>
              <th>Visible</th>
              <th>Auto Category</th>
              <th>Manual Category</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for category, items in grouped_menu.items %}
              {% for item in items %}
              <tr id="row-{{ item.id }}">
                <td><input type="checkbox" class="item-checkbox" value="{{ item.id }}"></td>
                <td>{{ forloop.counter }}</td>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    {% if item.image_local %}
                      <img src="{{ MEDIA_URL }}{{ item.image_local }}" class="menu-thumb" alt="{{ item.item_name }}">
                    {% elif item.image_url %}
                      <img src="{{ item.image_url }}" class="menu-thumb" alt="{{ item.item_name }}">
                    {% else %}
                      <img src="https://via.placeholder.com/40x40?text=No+Img" class="menu-thumb" alt="No image">
                    {% endif %}
                    <span class="fw-semibold">{{ item.item_name }}</span>
                  </div>
                </td>
                <td class="text-muted small">{{ item.description|default:"‚Äì"|truncatewords:10 }}</td>
                <td>{% if item.price %}{{ item.price|floatformat:3 }} KD{% else %}-{% endif %}</td>

                <!-- Visibility toggle -->
                <td>
                  <div class="form-check form-switch">
                    <input class="form-check-input visibility-toggle" type="checkbox"
                          data-item-id="{{ item.id }}"
                          {% if item.is_visible %}checked{% endif %}>
                  </div>
                </td>

                <!-- ‚úÖ Auto Category editable -->
                <td>
                  <select class="form-select form-select-sm category-select" data-type="auto" data-item-id="{{ item.id }}">
                    <option value="">‚Äî None ‚Äî</option>
                    {% for cat in all_categories %}
                      <option value="{{ cat.id }}" {% if cat in item.categories.all %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                  </select>
                </td>

                <!-- ‚úÖ Manual Category editable -->
                <td>
                  <select class="form-select form-select-sm manual-category-select" data-item-id="{{ item.id }}" multiple>
                    {% for cat in all_manual_categories %}
                      <option value="{{ cat.id }}" {% if cat in item.manual_categories.all %}selected{% endif %}>
                        {{ cat.name }}
                      </option>
                    {% endfor %}
                  </select>
                </td>

                <!-- ‚úÖ Edit + Delete actions -->
                <td>
                  <div class="d-flex gap-1">
                    <a href="{% url 'edit_menu_item' hotel.id item.id %}" class="btn btn-outline-warning btn-sm">Edit</a>
                    <button class="btn btn-outline-danger btn-sm delete-item" data-id="{{ item.id }}">Delete</button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Grid View -->
    <div id="gridView" class="d-none">
      {% for category, items in grouped_menu.items %}
      <div class="mb-5">
        <h3 class="border-bottom pb-2 mb-3 text-primary fw-bold">{{ category }}</h3>
        <div class="row g-4">
          {% for item in items %}
          <div class="col-md-4 col-lg-3">
            <div class="card h-100 shadow-sm">
              {% if item.image_local %}
                <img src="{{ MEDIA_URL }}{{ item.image_local }}" class="card-img-top" alt="{{ item.item_name }}">
              {% elif item.image_url %}
                <img src="{{ item.image_url }}" class="card-img-top" alt="{{ item.item_name }}">
              {% else %}
                <img src="https://via.placeholder.com/300x200?text=No+Image" class="card-img-top" alt="No image">
              {% endif %}
              <div class="card-body d-flex flex-column">
                <h5 class="card-title fw-semibold">{{ item.item_name }}</h5>
                {% if item.price %}
                  <p class="text-success mb-1 fw-bold">{{ item.price|floatformat:3 }} KD</p>
                {% endif %}
                {% if item.description %}
                  <p class="text-muted small mb-2" style="min-height:48px;">
                    {{ item.description|truncatewords:20 }}
                  </p>
                {% endif %}
                <!-- <div class="mt-auto">
                  <a href="{% url 'edit_menu_item' hotel.id item.id %}" class="btn btn-sm btn-outline-warning w-100">Edit</a>
                </div> -->
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center"><p class="text-muted fs-5">No menu items found for this hotel.</p></div>
  {% endif %}
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".manual-category-select").forEach(el => {
    new Choices(el, {
      removeItemButton: true,
      searchEnabled: true,
      placeholderValue: "Select manual categories..."
    });
  });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function() {
  const selects = document.querySelectorAll(".manual-category-select");

  selects.forEach(select => {
    // Save categories when user changes selection
    select.addEventListener("change", async function() {
      const itemId = this.dataset.itemId;
      const selectedIds = Array.from(this.selectedOptions).map(opt => opt.value);

      try {
        const response = await fetch(`/api/menu/${itemId}/update_category/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({
            type: "manual",
            category_ids: selectedIds
          })
        });

        const data = await response.json();
        if (response.ok) {
          console.log(`‚úÖ Updated manual categories for item ${itemId}`);
        } else {
          alert(data.error || "Failed to update categories.");
        }
      } catch (error) {
        alert("Network error while updating categories.");
      }
    });
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {

  // ==========================
  // üîπ List / Grid Toggle
  // ==========================
  const btnList = document.getElementById("btnList");
  const btnGrid = document.getElementById("btnGrid");
  const listView = document.getElementById("listView");
  const gridView = document.getElementById("gridView");

  if (btnList && btnGrid && listView && gridView) {
    btnList.addEventListener("click", () => {
      listView.classList.remove("d-none");
      gridView.classList.add("d-none");
      btnList.classList.add("active");
      btnGrid.classList.remove("active");
    });

    btnGrid.addEventListener("click", () => {
      gridView.classList.remove("d-none");
      listView.classList.add("d-none");
      btnGrid.classList.add("active");
      btnList.classList.remove("active");
    });
  }

  // ==========================
  // üîπ Select All Checkbox
  // ==========================
  const selectAll = document.getElementById("selectAll");
  if (selectAll) {
    selectAll.addEventListener("change", function() {
      document.querySelectorAll(".item-checkbox").forEach(cb => cb.checked = this.checked);
    });
  }

  // ==========================
  // üîπ Real-time Search (by name)
  // ==========================
  const searchInput = document.getElementById("menuSearch");
  if (searchInput) {
    searchInput.addEventListener("input", function() {
      const keyword = this.value.trim().toLowerCase();
      const rows = document.querySelectorAll("#menuTable tbody tr");
      rows.forEach(row => {
        const nameCell = row.querySelector("td:nth-child(3)");
        const nameText = nameCell ? nameCell.innerText.toLowerCase() : "";
        row.style.display = keyword === "" || nameText.includes(keyword) ? "" : "none";
      });
    });
  }

  // ==========================
  // üîπ Inline Category Update
  // ==========================
  document.querySelectorAll(".category-select").forEach(select => {
    select.addEventListener("change", async function() {
      const itemId = this.dataset.itemId;
      const type = this.dataset.type;
      const selectedId = this.value;
      try {
        const response = await fetch(`/api/menu/${itemId}/update_category/`, {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ type: type, category_id: selectedId })
        });
        if (!response.ok) alert("‚ö†Ô∏è Failed to update category");
      } catch {
        alert("‚ö†Ô∏è Network error while updating category");
      }
    });
  });

  // ==========================
  // üîπ Visibility Toggle
  // ==========================
  document.querySelectorAll(".visibility-toggle").forEach(toggle => {
    toggle.addEventListener("change", async function() {
      const itemId = this.dataset.itemId;
      const isVisible = this.checked;
      try {
        const response = await fetch(`/api/menu/${itemId}/toggle_visibility/`, {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ visible: isVisible })
        });
        if (!response.ok) {
          alert("‚ö†Ô∏è Failed to update visibility");
          this.checked = !isVisible;
        }
      } catch {
        alert("‚ö†Ô∏è Network error");
        this.checked = !isVisible;
      }
    });
  });

  // ==========================
  // üîπ Single Item Delete
  // ==========================
  document.querySelectorAll(".delete-item").forEach(btn => {
    btn.addEventListener("click", async function() {
      const id = this.dataset.id;
      if (!confirm("Are you sure you want to delete this menu item?")) return;
      const response = await fetch(`/api/menu/${id}/delete/`, {
        method: "POST",
        credentials: "same-origin",
        headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
      });
      if (response.ok) {
        document.getElementById(`row-${id}`).remove();
      } else {
        alert("Failed to delete menu item.");
      }
    });
  });

  // ==========================
  // üîπ Bulk Delete
  // ==========================
  const deleteSelected = document.getElementById("deleteSelected");
  if (deleteSelected) {
    deleteSelected.addEventListener("click", async () => {
      const selected = Array.from(document.querySelectorAll(".item-checkbox:checked")).map(cb => cb.value);
      if (selected.length === 0) return alert("Please select at least one item.");
      if (!confirm(`Delete ${selected.length} menu item(s)?`)) return;

      const response = await fetch(`/api/menu/bulk_delete/`, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ ids: selected })
      });
      if (response.ok) {
        selected.forEach(id => {
          const row = document.getElementById(`row-${id}`);
          if (row) row.remove();
        });
      } else {
        alert("Failed to delete selected items.");
      }
    });
  }

});
</script>


<style>
.table thead th { font-weight: 600; background-color: #f8f9fa; }
.table td { vertical-align: middle; }
.menu-thumb {
  width: 40px; height: 40px; object-fit: cover;
  border-radius: 6px; box-shadow: 0 0 3px rgba(0,0,0,0.2);
}
.btn-group .btn.active {
  background-color: #0d6efd !important; color: white !important;
}
.card-img-top { height: 180px; object-fit: cover; }
.form-switch .form-check-input { cursor: pointer; }
#menuSearch { transition: box-shadow 0.2s ease; }
#menuSearch:focus {
  box-shadow: 0 0 5px rgba(13, 110, 253, 0.3);
  border-color: #0d6efd;
}
.menu-thumb {
  width: 40px; height: 40px; object-fit: cover;
  border-radius: 6px; box-shadow: 0 0 3px rgba(0,0,0,0.2);
}
.form-select-sm { min-width: 120px; }
.table td { vertical-align: middle; }
</style>
{% endblock %}
